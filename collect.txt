 let animationFrameId: number;

  const animate = () => {
    // Perform animation-related updates
    animationFrameId = requestAnimationFrame(animate);
  };

  // Start animation loop
  animate();

  // Cleanup on widget removal
  const removeAnimations = () => {
    cancelAnimationFrame(animationFrameId);
  };

  // Adjust spin speed based on proximity or hover
  const adjustSpinSpeed = (isNear: boolean, isHovered: boolean, textRing: HTMLElement) => {
    if (isHovered) {
      textRing.classList.add('fast-spin');
      textRing.classList.remove('slow-spin');
    } else if (isNear) {
      textRing.classList.add('slow-spin');
      textRing.classList.remove('fast-spin');
    } else {
      textRing.classList.remove('slow-spin', 'fast-spin');
    }
  };

  // Toggle panel with smooth transitions
  const togglePanel = (isOpen: boolean): void => {
    const panel = document.getElementById('now-widget-panel');
    if (panel) {
      if (isOpen) {
        panel.classList.add('open');
      } else {
        panel.classList.remove('open');
      }
    }
  };

  // Mouse Movement Event to Adjust Animation
  document.addEventListener('mousemove', (e) => {
    const rect = button.getBoundingClientRect();
    const distance = Math.sqrt(
      Math.pow(e.clientX - (rect.left + rect.width / 2), 2) +
      Math.pow(e.clientY - (rect.top + rect.height / 2), 2)
    );
    const isNear = distance < 200; // Proximity Threshold
    const isHovered = button.matches(':hover');
    adjustSpinSpeed(isNear, isHovered, textRing);
  });




  const addEventListeners = (): void => {
    // Click Event to Toggle Panel
    const button = document.getElementById('now-widget-button');
    button?.addEventListener('click', () => togglePanel(true));

    // Scroll Event to Hide/Show Button
    window.addEventListener('scroll', handleScroll);

    // Mouse Movement Event to Adjust Animation
    document.addEventListener('mousemove', handleMouseMove);
};

// Define the event handler functions
const handleScroll = () => {
    const nowButton = document.getElementById('now-widget-button');
    if (window.scrollY > 300) {
        nowButton?.classList.add('hidden');
    } else {
        nowButton?.classList.remove('hidden');
    }
};

const handleMouseMove = (e: MouseEvent) => {
    const nowButton = document.getElementById('now-widget-button');
    if (nowButton) {
        const rect = nowButton.getBoundingClientRect();
        const distance = Math.sqrt(
            Math.pow(e.clientX - (rect.left + rect.width / 2), 2) +
            Math.pow(e.clientY - (rect.top + rect.height / 2), 2)
        );
        const isNear = distance < 200; // Proximity Threshold
        const isHovered = nowButton.matches(':hover');
        const textRing = nowButton.querySelector('.text-ring') as HTMLElement;
        if (textRing) {
            adjustSpinSpeed(isNear, isHovered, textRing);
        }
    }
};





    // Create widget container
    createWidgetContainer();

    // Create and append NowButton
    const button = createNowButton(() => togglePanel(true), {
        color: buttonColor,
        size: buttonSize ? parseInt(buttonSize) : undefined,
        backgroundColor: 'transparent',

// Initialize the widget when the script is loaded



    shadow.appendChild(createNowButton(...));
    shadow.appendChild(createNowPanel(...));

    document.getElementById('now-widget-container')?.appendChild(button);

    // Create and append Panel
    showLoading();
    try {
        const posts = await fetchUserData(userId, token);
        const user = await fetchUserInfo(userId, token);
        setPosts(posts);
        setUser(user);
        createPanel();
        setPosts(posts);
        setUser(user);
        setLoading(false);
        const style = document.createElement('link');
        style.rel = 'stylesheet';
        style.href = 'path/to/nowWidgetStyle.css';
        shadow.appendChild(style);
    } catch (error) {
        handleError(error.message);
    } finally {
        hideLoading();
    }


    const panel = createNowPanel({ userId, token, posts, user });

    // Fetch and render data
    const posts = await fetchUserPosts(userId, token);
    const user = await fetchUserInfo(userId, token);
    renderPosts(posts);

    // Apply theme and position settings
    applyTheme(theme);
    setPosition(position);

    // Add Event Listeners





    export * from './api/auth';
export * from './components/NowButton';
export * from './components/NowPanelContent';
export * from './types/types';
export * from './utils/nowWidgetUtils';




import '../css/nowWidgetStyles.css';
import { fetchUserInfo, fetchUserPosts } from './ts/api/auth';
import { adjustSpinSpeed, createNowButton } from './ts/components/NowButton';
import { setLoading, setPosts, setUser } from './ts/state/state';
import { Post } from './ts/types/types';
import { createWidgetContainer, getScriptAttributes, togglePanel } from './ts/utils/nowWidgetUtils';
import { createPanel } from './utils/nowWidgetUtils';
import { applyTheme, renderPosts, setPosition } from './utils/styleUtils';
import { initializeNowWidget } from './components/NowWidget';
import { addEventListeners } from './utils/eventHandlers';



const createShadowContainer = (): ShadowRoot => {
    const container = document.createElement('div');
    const shadow = container.attachShadow({ mode: 'open' });
    document.body.appendChild(container);
    return shadow;
};

const fetchUserPosts = async (userId: string, token: string): Promise<Post[]> => {
    try {
        const response = await fetch(`https://api.yourdomain.com/users/${userId}/posts`, {
            headers: {
                'Authorization': `Bearer ${token}`,
            },
        });
        if (!response.ok) {
            throw new Error(`Failed to fetch posts: ${response.statusText}`);
        }
        const data = await response.json();
        return data.posts;
    } catch (error) {
        console.error(error);
        return [];
    }
};

const renderPosts = (posts: Post[]): void => {
    const content = document.getElementById('now-widget-content');
    if (content) {
        content.innerHTML = '<h2>Your Posts</h2>';
        posts.forEach(post => {
            const postEl = document.createElement('div');
            postEl.className = 'now-widget-post';
            postEl.innerHTML = `<h3>${post.title}</h3> <p>${post.content}</p>`;
            content.appendChild(postEl);
        });
    }
};




const init = async (): Promise<void> => {
    const shadow = createShadowContainer();
    const attributes = getScriptAttributes();
    if (!attributes) return;
    const { userId, token, theme, position, buttonColor, buttonSize } = attributes;

    // Create widget container
    createWidgetContainer();

    // Create and append NowButton
    const button = createNowButton(() => togglePanel(true), {
        color: buttonColor,
        size: buttonSize ? parseInt(buttonSize) : undefined,
        backgroundColor: 'transparent',
    });

    shadow.appendChild(createNowButton(...));
    shadow.appendChild(createNowPanel(...));

    document.getElementById('now-widget-container')?.appendChild(button);

    // Create and append Panel
    showLoading();
    try {
        const posts = await fetchUserData(userId, token);
        const user = await fetchUserInfo(userId, token);
        setPosts(posts);
        setUser(user);
        createPanel();
        setPosts(posts);
        setUser(user);
        setLoading(false);
        const style = document.createElement('link');
        style.rel = 'stylesheet';
        style.href = 'path/to/nowWidgetStyle.css';
        shadow.appendChild(style);
    } catch (error) {
        handleError(error.message);
    } finally {
        hideLoading();
    }


    const panel = createNowPanel({ userId, token, posts, user });

    // Fetch and render data
    const posts = await fetchUserPosts(userId, token);
    const user = await fetchUserInfo(userId, token);
    renderPosts(posts);

    // Apply theme and position settings
    applyTheme(theme);
    setPosition(position);

    // Add Event Listeners
    addEventListeners();
};